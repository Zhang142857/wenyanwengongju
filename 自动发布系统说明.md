# ğŸš€ è‡ªåŠ¨å‘å¸ƒç³»ç»Ÿè¯´æ˜

## æ¦‚è¿°

æœ¬é¡¹ç›®å·²é›†æˆå®Œæ•´çš„è‡ªåŠ¨åŒ–å‘å¸ƒç³»ç»Ÿï¼Œå¯ä»¥ä¸€é”®å®Œæˆä»æ‰“åŒ…åˆ°éƒ¨ç½²çš„å…¨éƒ¨æµç¨‹ã€‚

## ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æœ¬åœ°å¼€å‘ç¯å¢ƒ    â”‚
â”‚  (æ–‡è¨€æ–‡å°å·¥å…·)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ npm run release:patch
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è‡ªåŠ¨åŒ–å‘å¸ƒè„šæœ¬                  â”‚
â”‚  (scripts/release-patch.js)     â”‚
â”‚                                  â”‚
â”‚  1. æ¸…ç†æ„å»ºæ–‡ä»¶                 â”‚
â”‚  2. æ„å»º Next.js                â”‚
â”‚  3. æ‰“åŒ… Electron               â”‚
â”‚  4. è¯»å– CHANGELOG              â”‚
â”‚  5. ä¸Šä¼ åˆ°æ›´æ–°æœåŠ¡å™¨ â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  6. æ›´æ–°æœåŠ¡ç«¯é…ç½®          â”‚    â”‚
â”‚  7. éƒ¨ç½²æ›´æ–°æœåŠ¡            â”‚    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â”‚ HTTPS POST
                                  â”‚
                                  â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  æ›´æ–°æœåŠ¡å™¨               â”‚
                    â”‚  (Cloudflare Workers)    â”‚
                    â”‚                          â”‚
                    â”‚  - æ¥æ”¶æ–‡ä»¶ä¸Šä¼           â”‚
                    â”‚  - å­˜å‚¨åˆ° R2            â”‚
                    â”‚  - è®¡ç®—æ–‡ä»¶å“ˆå¸Œ          â”‚
                    â”‚  - è¿”å›ä¸Šä¼ ç»“æœ          â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â”‚ è‡ªåŠ¨éƒ¨ç½²
                                  â”‚
                                  â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  ç‰ˆæœ¬é…ç½®æ›´æ–°             â”‚
                    â”‚  (updateCheck.js)        â”‚
                    â”‚                          â”‚
                    â”‚  - æ›´æ–°ç‰ˆæœ¬å·            â”‚
                    â”‚  - æ›´æ–°æ–‡ä»¶å“ˆå¸Œ          â”‚
                    â”‚  - æ›´æ–°æ›´æ–°è¯´æ˜          â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â”‚
                                  â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  ç”¨æˆ·ç«¯åº”ç”¨               â”‚
                    â”‚                          â”‚
                    â”‚  - æ£€æŸ¥æ›´æ–°              â”‚
                    â”‚  - ä¸‹è½½æ–°ç‰ˆæœ¬            â”‚
                    â”‚  - éªŒè¯æ–‡ä»¶å®Œæ•´æ€§        â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ ¸å¿ƒç»„ä»¶

### 1. å‘å¸ƒè„šæœ¬ (release-patch.js)

**ä½ç½®**: `scripts/release-patch.js`

**åŠŸèƒ½**:
- è‡ªåŠ¨åŒ–æ•´ä¸ªå‘å¸ƒæµç¨‹
- ä¸Šä¼ æ–‡ä»¶åˆ°æ›´æ–°æœåŠ¡å™¨
- æ›´æ–°æœåŠ¡ç«¯é…ç½®
- éƒ¨ç½²æ›´æ–°æœåŠ¡

**é…ç½®**:
```javascript
const UPDATE_SERVER = {
  url: 'https://update.156658.xyz',
  apiKey: 'your-secret-api-key-here',
  platform: 'windows'
};
```

### 2. é…ç½®æ›´æ–°è„šæœ¬ (update-server-config.js)

**ä½ç½®**: `scripts/update-server-config.js`

**åŠŸèƒ½**:
- è‡ªåŠ¨ä¿®æ”¹æœåŠ¡ç«¯ç‰ˆæœ¬é…ç½®
- æ›´æ–° VERSION_CONFIG

**ä½¿ç”¨**:
```bash
node scripts/update-server-config.js <version> <hash> <changelog>
```

### 3. æµ‹è¯•è„šæœ¬ (test-upload.js)

**ä½ç½®**: `scripts/test-upload.js`

**åŠŸèƒ½**:
- æµ‹è¯•æ›´æ–°æœåŠ¡å™¨è¿æ¥
- éªŒè¯ API å¯†é’¥
- æ£€æŸ¥æ¥å£å¯ç”¨æ€§

**ä½¿ç”¨**:
```bash
npm run test:upload
```

### 4. æ›´æ–°æœåŠ¡å™¨

**ä½ç½®**: `update/` ç›®å½•

**æŠ€æœ¯æ ˆ**:
- Cloudflare Workers (è®¡ç®—)
- Cloudflare R2 (å­˜å‚¨)

**API ç«¯ç‚¹**:
- `POST /api/update/upload` - ä¸Šä¼ æ–°ç‰ˆæœ¬
- `GET /api/update/check` - æ£€æŸ¥æ›´æ–°
- `GET /api/update/download/:version/:platform` - ä¸‹è½½æ–‡ä»¶
- `GET /health` - å¥åº·æ£€æŸ¥

## ä½¿ç”¨æµç¨‹

### é¦–æ¬¡é…ç½®

1. **å®‰è£…ä¾èµ–**
   ```bash
   npm install
   ```

2. **é…ç½® API å¯†é’¥**
   
   ç¼–è¾‘ `scripts/release-patch.js`:
   ```javascript
   const UPDATE_SERVER = {
     url: 'https://update.156658.xyz',
     apiKey: 'your-secret-api-key-here',  // ä¿®æ”¹è¿™é‡Œ
     platform: 'windows'
   };
   ```

3. **æµ‹è¯•é…ç½®**
   ```bash
   npm run test:upload
   ```

### æ—¥å¸¸å‘å¸ƒ

1. **æ›´æ–°ç‰ˆæœ¬å·**
   
   ç¼–è¾‘ `package.json`:
   ```json
   {
     "version": "1.0.3"
   }
   ```

2. **æ›´æ–° CHANGELOG**
   
   ç¼–è¾‘ `CHANGELOG.md`:
   ```markdown
   ## [1.0.3] - 2024-12-07
   
   ### æ–°å¢
   - æ–°åŠŸèƒ½æè¿°
   
   ### ä¿®å¤
   - Bug ä¿®å¤æè¿°
   ```

3. **è¿è¡Œå‘å¸ƒè„šæœ¬**
   ```bash
   npm run release:patch
   ```
   
   æˆ–åŒå‡»è¿è¡Œ:
   ```
   å‘å¸ƒæ–°ç‰ˆæœ¬.bat
   ```

4. **ç­‰å¾…å®Œæˆ**
   
   è„šæœ¬ä¼šè‡ªåŠ¨å®Œæˆæ‰€æœ‰æ­¥éª¤ï¼Œå¤§çº¦éœ€è¦ 5-10 åˆ†é’Ÿã€‚

5. **æµ‹è¯•æ›´æ–°**
   
   åœ¨æ—§ç‰ˆæœ¬åº”ç”¨ä¸­ç‚¹å‡»"æ£€æŸ¥æ›´æ–°"æŒ‰é’®ã€‚

## é…ç½®è¯´æ˜

### API å¯†é’¥é…ç½®

API å¯†é’¥éœ€è¦åœ¨ä¸¤ä¸ªåœ°æ–¹ä¿æŒä¸€è‡´ï¼š

1. **å®¢æˆ·ç«¯** (`scripts/release-patch.js`):
   ```javascript
   apiKey: 'your-secret-api-key-here'
   ```

2. **æœåŠ¡ç«¯** (`update/wrangler.toml`):
   ```toml
   [env.production]
   vars = { API_KEY = "your-secret-api-key-here" }
   ```

### æ›´æ–°æœåŠ¡å™¨åœ°å€

å¦‚æœä½¿ç”¨è‡ªå®šä¹‰åŸŸåï¼Œä¿®æ”¹ï¼š

```javascript
const UPDATE_SERVER = {
  url: 'https://your-domain.com',  // ä¿®æ”¹è¿™é‡Œ
  // ...
};
```

### å¹³å°é…ç½®

æ”¯æŒçš„å¹³å°ï¼š
- `windows` - Windows
- `mac` - macOS
- `linux` - Linux

ä¿®æ”¹ `platform` å­—æ®µä»¥æ”¯æŒå…¶ä»–å¹³å°ã€‚

## å®‰å…¨æ€§

### 1. API è®¤è¯

- æ‰€æœ‰ä¸Šä¼ è¯·æ±‚éœ€è¦ Bearer Token è®¤è¯
- API å¯†é’¥å­˜å‚¨åœ¨ç¯å¢ƒå˜é‡ä¸­
- ä¸è¦å°† API å¯†é’¥æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶

### 2. æ–‡ä»¶éªŒè¯

- è‡ªåŠ¨è®¡ç®— SHA256 å“ˆå¸Œ
- å®¢æˆ·ç«¯ä¸‹è½½åéªŒè¯æ–‡ä»¶å®Œæ•´æ€§
- é˜²æ­¢æ–‡ä»¶è¢«ç¯¡æ”¹

### 3. é€Ÿç‡é™åˆ¶

- æ£€æŸ¥æ›´æ–°ï¼š100 è¯·æ±‚/åˆ†é’Ÿ
- ä¸‹è½½æ–‡ä»¶ï¼š50 è¯·æ±‚/åˆ†é’Ÿ
- åŸºäºå®¢æˆ·ç«¯ IP

## æ•…éšœæ’æŸ¥

### é—®é¢˜ï¼šä¸Šä¼ å¤±è´¥

**æ£€æŸ¥æ¸…å•**:
- [ ] API å¯†é’¥æ˜¯å¦æ­£ç¡®
- [ ] æ›´æ–°æœåŠ¡å™¨æ˜¯å¦è¿è¡Œ
- [ ] ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸
- [ ] æ–‡ä»¶å¤§å°æ˜¯å¦è¶…è¿‡ 500MB

**è§£å†³æ–¹æ³•**:
```bash
# æµ‹è¯•æœåŠ¡å™¨è¿æ¥
npm run test:upload

# æŸ¥çœ‹è¯¦ç»†é”™è¯¯
# æ£€æŸ¥è„šæœ¬è¾“å‡ºçš„é”™è¯¯ä¿¡æ¯
```

### é—®é¢˜ï¼šé…ç½®æ›´æ–°å¤±è´¥

**æ£€æŸ¥æ¸…å•**:
- [ ] update ç›®å½•æ˜¯å¦å­˜åœ¨
- [ ] updateCheck.js æ–‡ä»¶è·¯å¾„æ˜¯å¦æ­£ç¡®

**è§£å†³æ–¹æ³•**:
```bash
# æ‰‹åŠ¨æ›´æ–°é…ç½®
cd update
# ç¼–è¾‘ src/handlers/updateCheck.js
npm run deploy
```

### é—®é¢˜ï¼šéƒ¨ç½²å¤±è´¥

**æ£€æŸ¥æ¸…å•**:
- [ ] Cloudflare å‡­è¯æ˜¯å¦é…ç½®
- [ ] wrangler æ˜¯å¦å®‰è£…

**è§£å†³æ–¹æ³•**:
```bash
# å®‰è£… wrangler
npm install -g wrangler

# ç™»å½• Cloudflare
wrangler login

# æ‰‹åŠ¨éƒ¨ç½²
cd update
npm run deploy
```

## æœ€ä½³å®è·µ

### 1. ç‰ˆæœ¬å·ç®¡ç†

éµå¾ªè¯­ä¹‰åŒ–ç‰ˆæœ¬ï¼š
- **PATCH (x.y.Z)**: Bug ä¿®å¤ã€å°æ”¹è¿›
- **MINOR (x.Y.z)**: æ–°åŠŸèƒ½ã€å‘åå…¼å®¹
- **MAJOR (X.y.z)**: é‡å¤§æ›´æ–°ã€å¯èƒ½ä¸å…¼å®¹

### 2. ç°åº¦å‘å¸ƒ

å¯¹äºé‡å¤§æ›´æ–°ï¼š
1. é¦–æ¬¡å‘å¸ƒè®¾ç½® 10%
2. ç›‘æ§ 24 å°æ—¶
3. é€æ­¥å¢åŠ åˆ° 50%ã€100%

### 3. æ›´æ–°è¯´æ˜

åœ¨ CHANGELOG.md ä¸­æ¸…æ™°æè¿°ï¼š
- æ–°å¢åŠŸèƒ½
- æ”¹è¿›å†…å®¹
- ä¿®å¤çš„ Bug
- å·²çŸ¥é—®é¢˜

### 4. æµ‹è¯•æµç¨‹

å‘å¸ƒå‰ï¼š
- [ ] æœ¬åœ°æµ‹è¯•æ–°åŠŸèƒ½
- [ ] è¿è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•
- [ ] æµ‹è¯•å®‰è£…ç¨‹åº
- [ ] æµ‹è¯•æ›´æ–°æµç¨‹

## ç›‘æ§å’Œæ—¥å¿—

### æŸ¥çœ‹æ›´æ–°æœåŠ¡æ—¥å¿—

```bash
cd update
npx wrangler tail
```

### æŸ¥çœ‹ R2 å­˜å‚¨

```bash
cd update
npx wrangler r2 object list app-updates
```

### æŸ¥çœ‹éƒ¨ç½²å†å²

```bash
cd update
npx wrangler deployments list
```

## æˆæœ¬ä¼°ç®—

- **Workers**: å…è´¹ï¼ˆ10 ä¸‡è¯·æ±‚/å¤©ï¼‰
- **R2 å­˜å‚¨**: $0.015/GB/æœˆ
- **æ•°æ®ä¼ è¾“**: $0.02/GBï¼ˆå‡ºç«™ï¼‰

å¯¹äº 50 ç”¨æˆ·ï¼Œæœˆæˆæœ¬é€šå¸¸ < $5

## ç›¸å…³æ–‡æ¡£

- [å‘å¸ƒæ–°ç‰ˆæœ¬æŒ‡å—.md](å‘å¸ƒæ–°ç‰ˆæœ¬æŒ‡å—.md) - è¯¦ç»†å‘å¸ƒæµç¨‹
- [scripts/README.md](scripts/README.md) - è„šæœ¬è¯´æ˜
- [update/README.md](../update/README.md) - æ›´æ–°æœåŠ¡æ–‡æ¡£
- [update/API_INTEGRATION.md](../update/API_INTEGRATION.md) - API å¯¹æ¥æ–‡æ¡£

## æŠ€æœ¯æ”¯æŒ

é‡åˆ°é—®é¢˜ï¼Ÿ

1. æŸ¥çœ‹ [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥) éƒ¨åˆ†
2. è¿è¡Œ `npm run test:upload` è¯Šæ–­
3. æŸ¥çœ‹ Wrangler æ—¥å¿—: `wrangler tail`
4. æ£€æŸ¥ API å‚æ•°æ˜¯å¦æ­£ç¡®

---

**ç‰ˆæœ¬**: 1.0.0  
**æœ€åæ›´æ–°**: 2024-12-07
