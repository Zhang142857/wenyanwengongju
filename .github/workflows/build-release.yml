name: Build and Release

on:
  push:
    branches: [main]
    tags:
      - 'v*'
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: '18'

jobs:
  # Build job
  build:
    runs-on: windows-latest
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test
        continue-on-error: true

      - name: Build Next.js
        run: npm run build

      - name: Build Electron (Windows)
        run: npx electron-builder --win --x64 --ia32 --publish never
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: |
            dist/*.exe
            dist/*.exe.blockmap
            dist/latest.yml
          retention-days: 30

  # Release job - only runs on tags
  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-build
          path: dist/

      - name: List artifacts
        run: ls -la dist/

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Generate release notes
        id: release_notes
        run: |
          echo "RELEASE_NOTES<<EOF" >> $GITHUB_OUTPUT
          echo "## 文言文小工具 v${{ steps.version.outputs.VERSION }}" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "### 下载" >> $GITHUB_OUTPUT
          echo "- Windows 安装包: \`文言文查询 Setup ${{ steps.version.outputs.VERSION }}.exe\`" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "### 安装说明" >> $GITHUB_OUTPUT
          echo "1. 下载 .exe 安装包" >> $GITHUB_OUTPUT
          echo "2. 双击运行安装程序" >> $GITHUB_OUTPUT
          echo "3. 按照向导完成安装" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "### 系统要求" >> $GITHUB_OUTPUT
          echo "- Windows 7/8/10/11" >> $GITHUB_OUTPUT
          echo "- 至少 2GB RAM" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: v${{ steps.version.outputs.VERSION }}
          body: ${{ steps.release_notes.outputs.RELEASE_NOTES }}
          draft: false
          prerelease: false
          files: |
            dist/*.exe
            dist/latest.yml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # 生成静态更新 JSON 并推送到仓库
  update-json:
    needs: release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get release info
        id: release
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          
          # 获取 release 信息
          RELEASE_DATA=$(curl -s "https://api.github.com/repos/${{ github.repository }}/releases/tags/v$VERSION")
          
          CHANGELOG=$(echo "$RELEASE_DATA" | jq -r '.body // ""')
          PUBLISHED_AT=$(echo "$RELEASE_DATA" | jq -r '.published_at // ""')
          
          # 获取 Windows 安装包信息
          ASSET=$(echo "$RELEASE_DATA" | jq -r '.assets[] | select(.name | test(".*\\.(exe)$"; "i")) | select(.name | test("Setup"; "i")) | {name, size, browser_download_url} | @base64' | head -1)
          
          if [ -n "$ASSET" ]; then
            ASSET_NAME=$(echo "$ASSET" | base64 -d | jq -r '.name')
            ASSET_SIZE=$(echo "$ASSET" | base64 -d | jq -r '.size')
            ASSET_URL=$(echo "$ASSET" | base64 -d | jq -r '.browser_download_url')
          else
            ASSET_NAME=""
            ASSET_SIZE=0
            ASSET_URL=""
          fi
          
          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "PUBLISHED_AT=$PUBLISHED_AT" >> $GITHUB_OUTPUT
          echo "ASSET_NAME=$ASSET_NAME" >> $GITHUB_OUTPUT
          echo "ASSET_SIZE=$ASSET_SIZE" >> $GITHUB_OUTPUT
          echo "ASSET_URL=$ASSET_URL" >> $GITHUB_OUTPUT

      - name: Generate update.json
        run: |
          cat > public/update.json << 'JSONEOF'
          {
            "version": "${{ steps.release.outputs.VERSION }}",
            "changelog": ${{ toJSON(steps.release.outputs.CHANGELOG) }},
            "published_at": "${{ steps.release.outputs.PUBLISHED_AT }}",
            "platforms": {
              "windows": {
                "download_url": "${{ steps.release.outputs.ASSET_URL }}",
                "size": ${{ steps.release.outputs.ASSET_SIZE || 0 }},
                "name": "${{ steps.release.outputs.ASSET_NAME }}"
              }
            },
            "generated_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          JSONEOF
          
          echo "Generated update.json:"
          cat public/update.json

      - name: Commit and push update.json
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add public/update.json
          git diff --staged --quiet || git commit -m "chore: update update.json for v${{ steps.release.outputs.VERSION }}"
          git push origin main

  # Notify Cloudflare Worker to refresh cache
  notify-cdn:
    needs: update-json
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: Trigger CDN cache refresh
        run: |
          curl -X POST "https://update.156658.xyz/api/refresh-cache" \
            -H "Content-Type: application/json" \
            -d '{"version": "${{ github.ref_name }}"}'
        continue-on-error: true
